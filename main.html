<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的作品集</title>
  <!-- Tailwind Config for Dark Mode -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card-bg-color: #ffffff; }
    .masonry-item { background-color: var(--card-bg-color); }
    body { transition: background-color 0.2s, color 0.2s; }
    .dark { --card-bg-color: #1f2937; }
    .dark body { background-color: #111827; color: #f9fafb; }
    .masonry { column-count: 4; column-gap: 1rem; }
    @media (max-width: 1024px) { .masonry { column-count: 2; } }
    @media (max-width: 640px) { .masonry { column-count: 1; } }
    .masonry-item { break-inside: avoid; margin-bottom: 1rem; transition: box-shadow 0.2s; cursor: pointer; }
    .masonry-item:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -4px rgba(0,0,0,0.1); }
    #settingsPanel > div { transform: scale(0.9); opacity: 0; transition: transform 0.2s, opacity 0.2s; }
    #settingsPanel.show > div { animation: modalZoom 0.2s forwards; }
    @keyframes modalZoom { from {transform:scale(0.9);opacity:0;} to {transform:scale(1);opacity:1;} }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200 dark:from-gray-900 dark:to-gray-800 font-sans min-h-screen">
  <nav class="fixed top-0 left-0 h-screen w-18 bg-white dark:bg-gray-800 border-r shadow flex flex-col items-center py-4">
    <!-- Sidebar Links -->
  </nav>
  <div id="content" class="ml-18 pt-6 lg:ml-18">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold tracking-tight">我的作品集</h1>
    </header>
    <main class="px-4 max-w-screen-xl mx-auto">
      <div id="gallery" class="masonry"></div>
      <button id="loadMore" class="mt-4 hidden px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">加载更多</button>
    </main>
    <div id="settingsPanel" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
      <div class="bg-white dark:bg-gray-800 dark:text-gray-200 rounded-xl p-4 w-80 space-y-4">
        <div class="flex justify-between items-center">
          <h2 class="font-semibold">设置</h2>
          <button id="closeSettings" class="text-2xl leading-none">&times;</button>
        </div>
        <label class="block text-sm">
          列数
          <input id="columnCountInput" type="number" min="1" max="6" value="4" class="mt-1 w-full border rounded p-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" />
        </label>
        <label class="block text-sm">
          加载卡片数量
          <input id="perPageInput" type="number" min="1" value="30" class="mt-1 w-full border rounded p-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" />
        </label>
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" id="darkModeToggle" class="form-checkbox h-5 w-5 text-blue-600" />
          暗色模式
        </label>
        <label class="block text-sm">
          自定义卡片背景色
          <input id="colorPicker" type="color" class="mt-1 w-full h-8 p-0 border-none rounded-full" />
        </label>
        <button id="applySettings" class="w-full py-2 rounded bg-blue-500 text-white">应用</button>
        <button id="clearCache" class="w-full py-2 rounded bg-red-500 text-white">清理缓存</button>
      </div>
    </div>
  </div>
  <script>
    // Theme & Color Persistence
    let cardBgColor = localStorage.getItem('cardBgColor') || '#ffffff';
    document.documentElement.style.setProperty('--card-bg-color', cardBgColor);
    const darkToggle = document.getElementById('darkModeToggle');
    const colorPicker = document.getElementById('colorPicker');
    function initTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') document.documentElement.classList.add('dark');
      darkToggle.checked = theme === 'dark';
      darkToggle.addEventListener('change', () => {
        if (darkToggle.checked) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme','dark');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme','light');
        }
      });
    }
    function initColor() {
      colorPicker.value = cardBgColor;
      colorPicker.addEventListener('input', () => {
        cardBgColor = colorPicker.value;
        localStorage.setItem('cardBgColor', cardBgColor);
        document.documentElement.style.setProperty('--card-bg-color', cardBgColor);
        document.querySelectorAll('.masonry-item').forEach(item => {
          item.style.backgroundColor = cardBgColor;
        });
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      initColor();
      // Initialize Gallery
      initGallery();
    });
    // Existing JS hooks: createImage, buildItems, renderPage, fetchLatest, initGallery, etc., updated for background
      const gallery = document.getElementById('gallery');
      const loadMoreBtn = document.getElementById('loadMore');
      const settingsPanel = document.getElementById('settingsPanel');
      const moreBtn = document.getElementById('moreBtn');
      const closeSettings = document.getElementById('closeSettings');
      const applySettings = document.getElementById('applySettings');
      const columnCountInput = document.getElementById('columnCountInput');
      const perPageInput = document.getElementById('perPageInput');
      const clearCacheBtn = document.getElementById('clearCache');
      const imageModal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImg');
      let imgScale = 1;

      const apiStored = localStorage.getItem('apiDomains') || localStorage.getItem('apiDomain') || '';
      const imgStored = localStorage.getItem('imgDomains') || '';
      let apiDomains = apiStored
        ? apiStored.split(/\r?\n|,/).map((s) => s.trim()).filter(Boolean)
        : [];
      let imgDomains = imgStored
        ? imgStored.split(/\r?\n|,/).map((s) => s.trim()).filter(Boolean)
        : [];
      if (apiDomains.length === 0 && Array.isArray(window.API_DOMAINS)) {
        apiDomains = window.API_DOMAINS;
      }
      if (imgDomains.length === 0 && Array.isArray(window.IMG_DOMAINS)) {
        imgDomains = window.IMG_DOMAINS;
      }
      function buildUrl(path, domain) {
        return domain ? domain.replace(/\/$/, '') + path : path;
      }
      function withDomain(path) {
        return buildUrl(path, imgDomains[0]);
      }
      function loadImgWithFallback(img) {
        const path = img.dataset.path;
        if (!path) return;
        let index = 0;
        function attempt() {
          img.src = buildUrl(path, imgDomains[index] || '');
        }
        img.onerror = () => {
          index++;
          if (index < imgDomains.length) attempt();
        };
        attempt();
      }
      async function fetchWithFallback(path, options = {}) {
        const isApi = path.startsWith('/api/wx') || path.startsWith('/api/article') || path.startsWith('/api/daily');
        const domains = isApi ? apiDomains : imgDomains;
        for (const d of domains) {
          try {
            const res = await fetch(buildUrl(path, d), options);
            if (res.ok) return res;
          } catch {}
        }
        return fetch(path, options);
      }

      const homeLink = document.querySelector('a[aria-label="\u4e3b\u9875"]');
      let notifyDot = null;

      function showDot() {
        if (!notifyDot) {
          notifyDot = document.createElement('span');
          notifyDot.className = 'notify-dot';
          homeLink.classList.add('relative');
          homeLink.appendChild(notifyDot);
        }
      }

      function hideDot() {
        if (notifyDot) {
          notifyDot.remove();
          notifyDot = null;
        }
      }

      function openImage(src) {
        imgScale = 1;
        modalImg.src = src;
        imageModal.classList.remove('hidden');
        imageModal.classList.add('flex', 'show');
      }

      function closeImage() {
        imageModal.classList.add('hidden');
        imageModal.classList.remove('flex', 'show');
        modalImg.src = '';
      }

      const savedCols = parseInt(localStorage.getItem('columnCount')) || 4;
      const savedPerPage = parseInt(localStorage.getItem('perPage')) || 30;

      const navEl = document.querySelector('nav');
      const contentEl = document.getElementById('content');
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

      const initialCols = isMobile ? 2 : savedCols;

      columnCountInput.value = String(initialCols);
      perPageInput.value = String(savedPerPage);
      gallery.style.columnCount = String(initialCols);

      if (isMobile) {
        document.body.classList.add('mobile');
        navEl.classList.add('mobile');
        contentEl.classList.remove('ml-[72px]');
        contentEl.classList.add('mb-[72px]');
      }

      let allItems = [];
      let currentPage = 0;
      let perPage = savedPerPage;

      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            loadImgWithFallback(img);
            obs.unobserve(img);
          }
        });
      }, { rootMargin: '100px' });

      function getRandomColor() {
        return '#' + Math.floor(Math.random() * 0xffffff).toString(16).padStart(6, '0');
      }

      function createImage(src, alt) {
        const img = document.createElement('img');
        img.className = 'masonry-item w-full rounded-2xl shadow object-cover hover:opacity-90 transition-opacity';
        img.dataset.path = `?url=${src}`;
        img.alt = alt;
        img.loading = 'lazy';
        // 随机高度以增强瀑布流效果
        const randomHeight = 180 + Math.random() * 120; // 180 - 300px
        img.style.height = `${randomHeight}px`;
        img.style.backgroundColor = getRandomColor();
        img.style.minHeight = '120px';
        img.style.opacity = '0';
        img.style.transition = 'opacity 0.5s';
        img.addEventListener('load', () => {
          img.style.opacity = '1';
          img.style.backgroundColor = '';
          img.style.minHeight = '';
        });
        observer.observe(img);
        img.addEventListener('click', () => openImage(img.src || buildUrl(img.dataset.path, imgDomains[0])));
        return img;
      }

      function buildItems(data) {
        const items = [];
        for (const [title, { description, images }] of Object.entries(data)) {
          items.push({
            type: 'title',
            html:
              `<div class="masonry-item p-5 bg-white rounded-2xl shadow hover:shadow-lg transition flex flex-col gap-2">\n  <h2 class="text-xl font-semibold text-slate-900">${title}</h2>\n  <p class="text-sm text-gray-600 leading-relaxed">${description}</p>\n</div>`
          });
          images.forEach((src) => {
            items.push({ type: 'image', src, alt: title });
          });
        }
        return items;
      }

      function renderPage() {
        gallery.innerHTML = '';
        const end = (currentPage + 1) * perPage;
        const items = allItems.slice(0, end);
        items.forEach((item) => {
          if (item.type === 'title') {
            gallery.insertAdjacentHTML('beforeend', item.html);
          } else if (item.type === 'image') {
            gallery.appendChild(createImage(item.src, item.alt));
          }
        });
        if (end >= allItems.length) {
          loadMoreBtn.classList.add('hidden');
        } else {
          loadMoreBtn.classList.remove('hidden');
        }
      }

      function applyData(data) {
        allItems = buildItems(data);
        currentPage = 0;
        renderPage();
      }

      async function fetchLatest() {
        const res = await fetchWithFallback('/api/wx', {
          headers: { 'x-skip-cache': '1' },
        });
        if (!res.ok) throw new Error('Network response was not ok');
        return await res.json();
      }

      async function initGallery() {
        const cachedStr = localStorage.getItem('wxData');
        let cached;
        if (cachedStr) {
          try { cached = JSON.parse(cachedStr); } catch {}
        }
        if (cached) {
          applyData(cached);
        }

        try {
          const latest = await fetchLatest();
          const latestStr = JSON.stringify(latest);
          if (!cachedStr) {
            localStorage.setItem('wxData', latestStr);
            applyData(latest);
          } else if (latestStr !== cachedStr) {
            localStorage.setItem('wxDataNew', latestStr);
            showDot();
          }
        } catch (err) {
          console.error('加载画廊失败:', err);
        }
      }

      loadMoreBtn.addEventListener('click', () => {
        currentPage++;
        renderPage();
      });

      moreBtn.addEventListener('click', (e) => {
        e.preventDefault();
        settingsPanel.classList.remove('hidden');
        settingsPanel.classList.add('flex', 'show');
      });

      closeSettings.addEventListener('click', () => {
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });

      applySettings.addEventListener('click', () => {
        const cols = Math.max(1, parseInt(columnCountInput.value) || 1);
        perPage = Math.max(1, parseInt(perPageInput.value) || 1);
        gallery.style.columnCount = String(cols);
        localStorage.setItem('columnCount', String(cols));
        localStorage.setItem('perPage', String(perPage));
        currentPage = 0;
        renderPage();
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });

      clearCacheBtn.addEventListener('click', async () => {
        ['wxData', 'wxDataNew', 'columnCount', 'perPage'].forEach((k) => localStorage.removeItem(k));
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map((n) => caches.delete(n)));
        }
        location.reload();
      });

      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) closeImage();
      });

      imageModal.addEventListener('wheel', (e) => {
        e.preventDefault();
        const factor = e.deltaY < 0 ? 1.1 : 0.9;
        imgScale = Math.min(5, Math.max(1, imgScale * factor));
        modalImg.style.transform = `scale(${imgScale})`;
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeImage();
      });

      document.addEventListener('DOMContentLoaded', initGallery);
      homeLink.addEventListener('click', () => {
        const newStr = localStorage.getItem('wxDataNew');
        if (newStr) {
          localStorage.setItem('wxData', newStr);
          localStorage.removeItem('wxDataNew');
          hideDot();
          try {
            applyData(JSON.parse(newStr));
          } catch (e) {}
        }
      });
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(console.error);
        });
      }
    </script>
    </div>
  </body>
</html>