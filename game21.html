<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»‘æ°å…‹21ç‚¹</title>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=ZCOOL+KuaiLe&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #f3eacb;
            --ink-color: #2b2b2b;
            --accent-color: #c0392b;
            --ui-font: 'ZCOOL KuaiLe', cursive;
            --hand-font: 'Patrick Hand', cursive;
        }

        body {
            background-color: var(--bg-color);
            color: var(--ink-color);
            font-family: var(--ui-font);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-image: linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px), linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            user-select: none;
            overflow-x: hidden;
        }

        /* é€šç”¨æ‰‹ç»˜è¾¹æ¡† */
        .sketch-border {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--ink-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.15);
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .zone-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* è£…å¤‡ä¾§è¾¹æ  */
        .equip-strip {
            width: 45px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 15px;
            flex-shrink: 0;
        }

        .equip-slot {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 2px dashed var(--ink-color);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4em;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
            cursor: default;
        }

        /* ä¸»åŒºåŸŸå‚ç›´å±…ä¸­ */
        .main-zone {
            flex-grow: 1;
            padding: 12px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px dashed var(--ink-color);
            padding-bottom: 5px;
            width: 100%;
        }

        .score-tag {
            font-family: var(--hand-font);
            font-weight: bold;
            font-size: 1.1em;
            color: #555;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 5px;
            border: none;
        }

        .cards-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 70px;
            align-items: center;
        }

        .card {
            width: 48px;
            height: 72px;
            border: 2px solid var(--ink-color);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            background: white;
            font-family: var(--hand-font);
            box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.15);
            font-weight: bold;
        }

        .card.hidden {
            background: repeating-linear-gradient(45deg, #ddd, #ddd 5px, #fff 5px, #fff 10px);
            color: transparent;
        }

        /* ä¸­é—´ä¿¡æ¯æ  */
        .dashboard {
            display: flex;
            justify-content: space-between;
            padding: 8px 20px;
            background: #fff;
            border: 2px solid var(--ink-color);
            border-radius: 15px 255px 15px 255px / 255px 15px 255px 15px;
            font-size: 1.1em;
            margin: 5px 0;
        }

        /* æŒ‰é’® */
        .controls-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-game {
            font-size: 1.3em;
            padding: 8px 20px;
            min-width: 80px;
            background: white;
            border: 3px solid var(--ink-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            cursor: pointer;
            font-family: var(--ui-font);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .btn-game:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .btn-game:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-game:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-bag {
            background-color: #f79984;
            color: var(--ink-color);
        }

        /* èƒŒåŒ…å¼¹çª— */
        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(243, 234, 203, 0.95);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
        }

        /* æ‰‹ç»˜é£æ ¼å¼¹çª— */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .hand-drawn-modal {
            background: #fff;
            border: 4px solid var(--ink-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 25px;
            max-width: 300px;
            text-align: center;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-title {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .modal-message {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            font-size: 1.2em;
            padding: 8px 20px;
            min-width: 80px;
            background: white;
            border: 3px solid var(--ink-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            cursor: pointer;
            font-family: var(--ui-font);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        .modal-btn:active {
            transform: scale(0.95);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
        }

        .modal-btn.confirm {
            background-color: #2ecc71;
            color: white;
        }

        .modal-btn.cancel {
            background-color: #e74c3c;
            color: white;
        }

        /* å³é”®èœå• */
        #ctx-menu {
            display: none;
            position: fixed;
            z-index: 3000;
            background: #fff;
            border: 2px solid var(--ink-color);
            border-radius: 5px 15px 5px 15px;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.2);
            flex-direction: column;
            overflow: hidden;
        }

        .ctx-btn {
            padding: 8px 15px;
            cursor: pointer;
            font-family: var(--ui-font);
            border-bottom: 1px dashed #ccc;
            transition: background 0.1s;
        }

        .ctx-btn:last-child {
            border-bottom: none;
        }

        .ctx-btn:hover {
            background: #f3eacb;
        }

        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 2000;
            display: none;
            white-space: pre-line;
            border: 1px solid #fff;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* éšè—æ‰€æœ‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        /* é’ˆå¯¹Firefoxæµè§ˆå™¨éšè—æ»šåŠ¨æ¡ */
        * {
            scrollbar-width: none;
        }

        /* é’ˆå¯¹IE/Edgeæµè§ˆå™¨éšè—æ»šåŠ¨æ¡ */
        * {
            -ms-overflow-style: none;
        }

        /* èƒŒåŒ…å¼¹çª— */
        .bag-window {
            width: 95%;
            max-width: 460px;
            background: #fff;
            border: 4px solid var(--ink-color);
            border-radius: 15px 255px 15px 255px / 255px 15px 255px 15px;
            padding: 20px;
            position: relative;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bag-close {
            position: absolute;
            top: -15px;
            right: -10px;
            width: 35px;
            height: 35px;
            background: #e74c3c;
            color: white;
            border: 2px solid var(--ink-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }

        .bag-top-section {
            display: flex;
            gap: 15px;
            border-bottom: 2px dashed #ccc;
            padding-bottom: 15px;
        }

        .bag-col-title {
            font-size: 0.9em;
            color: #888;
            text-align: center;
            margin-bottom: 5px;
        }

        .bag-equip-col {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            width: 50px;
        }

        .craft-layout {
            flex-grow: 1;
            background: #f8f8f8;
            border: 2px solid var(--ink-color);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .craft-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .craft-arrow {
            font-size: 2em;
            color: var(--ink-color);
            font-family: var(--hand-font);
            font-weight: bold;
        }

        .bag-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
            padding: 5px;
            background: #eee;
            border-radius: 5px;
        }

        .item-slot {
            aspect-ratio: 1;
            background: #fff;
            border: 1px solid #999;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            cursor: pointer;
            position: relative;
        }

        .item-slot:hover {
            background: #f0f0f0;
            border-color: var(--ink-color);
        }

        /* çˆ±å¿ƒåˆ†æ•°æ˜¾ç¤º */
        .hearts-container {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .heart {
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .heart.lost {
            opacity: 0.3;
            filter: grayscale(1);
        }

        /* çˆ±å¿ƒä¼¤å®³åŠ¨ç”» */
        .heart.damage {
            animation: heartDamage 0.6s ease-out;
        }

        @keyframes heartDamage {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            25% {
                transform: scale(1.3);
                opacity: 0.8;
            }

            50% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            75% {
                transform: scale(1.1);
                opacity: 0.4;
            }

            100% {
                transform: scale(1);
                opacity: 0.3;
                filter: grayscale(1);
            }
        }

        /* çˆ±å¿ƒé—ªçƒåŠ¨ç”» */
        .heart.warning {
            animation: heartWarning 1s infinite alternate;
        }

        @keyframes heartWarning {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            100% {
                transform: scale(1.1);
                filter: brightness(1.3);
            }
        }
    </style>
</head>

<body>

    <!-- å³é”®èœå• -->
    <div id="ctx-menu"></div>

    <h1>BlackJack !!!</h1>

    <div class="game-container">
        <div id="start-overlay">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 10px;">é€‰æ‹©çˆ±å¿ƒæ•°é‡</h3>
                    <div class="hearts-selector sketch-border"
                        style="padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <div class="hearts-container" id="preview-hearts"></div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn-game" onclick="changeHeartsCount(-1)"
                                style="font-size: 1.2em; padding: 5px 10px;">-</button>
                            <span id="hearts-count" style="font-size: 1.3em; font-weight: bold;">6</span>
                            <button class="btn-game" onclick="changeHeartsCount(1)"
                                style="font-size: 1.2em; padding: 5px 10px;">+</button>
                        </div>
                    </div>
                </div>
                <button class="btn-game" onclick="game.start()" style="font-size:1.8em; padding:15px 40px;">ğŸ‘‰
                    å¼€å§‹æŒ‘æˆ˜</button>
            </div>
        </div>

        <!-- AI åŒºåŸŸ -->
        <div class="zone-wrapper">
            <div class="equip-strip" id="ai-equip-strip">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="main-zone sketch-border" id="ai-zone">
                <div class="zone-header">
                    <div>
                        <span>ğŸ˜ˆ AIå¯¹æ‰‹</span>
                        <span class="score-tag" id="ai-point-display">0/21</span>
                        <small id="ai-buffs"></small>
                    </div>
                    <div class="hearts-container" id="ai-hearts-container"></div>
                </div>
                <div class="cards-container" id="ai-cards"></div>
                <div id="ai-msg"
                    style="font-size:0.8em; color:#888; text-align:center; min-height:1em; margin-top:5px;"></div>
            </div>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div class="dashboard">
            <span>ç¬¬ <b id="round-num">1</b> è½®</span>
            <span id="game-msg" style="color:#d35400; font-weight:bold;">å‡†å¤‡å°±ç»ª</span>
            <span>ç‰Œåº“: <b id="deck-count">11</b></span>
        </div>

        <!-- ç©å®¶åŒºåŸŸ -->
        <div class="zone-wrapper">
            <div class="equip-strip" id="player-equip-strip">
                <!-- ç©å®¶è£…å¤‡æ  (ä»…å±•ç¤º/ç‚¹å‡»èƒŒåŒ…) -->
                <div class="equip-slot" data-idx="0" title="æ‰“å¼€èƒŒåŒ…"></div>
                <div class="equip-slot" data-idx="1" title="æ‰“å¼€èƒŒåŒ…"></div>
                <div class="equip-slot" data-idx="2" title="æ‰“å¼€èƒŒåŒ…"></div>
                <div class="equip-slot" data-idx="3" title="æ‰“å¼€èƒŒåŒ…"></div>
            </div>
            <div class="main-zone sketch-border" id="player-zone">
                <div class="zone-header">
                    <div>
                        <span>ğŸ¤  ä½ çš„æ‰‹ç‰Œ</span>
                        <span class="score-tag" id="player-point-display">0/21</span>
                        <small id="player-buffs"></small>
                    </div>
                    <div class="hearts-container" id="player-hearts-container"></div>
                </div>
                <div class="cards-container" id="player-cards"></div>
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶ -->
        <div class="controls-area">
            <button id="btn-hit" class="btn-game" disabled onclick="game.playerAction('hit')">
                <span>ğŸ‘†</span> è¦ç‰Œ
            </button>
            <button id="btn-pass" class="btn-game" disabled onclick="game.playerAction('pass')">
                <span>ğŸ‘‹</span> è¿‡
            </button>
            <button class="btn-game btn-bag" onclick="inventory.toggle()">
                <span>ğŸ’</span> èƒŒåŒ…
            </button>
        </div>
    </div>

    <!-- èƒŒåŒ…å¼¹çª— -->
    <div class="modal-overlay" id="bag-modal">
        <div class="bag-window">
            <div class="bag-close" onclick="inventory.toggle()">Ã—</div>
            <h3 style="margin:0 0 10px 0; text-align:center;">ğŸ’ é“å…·èƒŒåŒ…</h3>

            <div class="bag-top-section">
                <!-- è£…å¤‡ (å¼¹çª—å†…å±•ç¤ºï¼Œä¸å¯å³é”®å¸ä¸‹) -->
                <div class="bag-equip-col">
                    <div class="bag-col-title">è£…å¤‡</div>
                    <div class="equip-slot" id="bag-equip-0" data-loc="equip" data-idx="0"></div>
                    <div class="equip-slot" id="bag-equip-1" data-loc="equip" data-idx="1"></div>
                    <div class="equip-slot" id="bag-equip-2" data-loc="equip" data-idx="2"></div>
                    <div class="equip-slot" id="bag-equip-3" data-loc="equip" data-idx="3"></div>
                </div>

                <!-- åˆæˆå° -->
                <div style="flex-grow:1; display:flex; flex-direction:column;">
                    <div class="bag-col-title">åˆæˆå° (å·¦é”®å–å‡º)</div>
                    <div class="craft-layout">
                        <div class="craft-input-grid">
                            <div class="item-slot" style="width:35px; height:35px;" data-loc="craft" data-idx="0"></div>
                            <div class="item-slot" style="width:35px; height:35px;" data-loc="craft" data-idx="1"></div>
                            <div class="item-slot" style="width:35px; height:35px;" data-loc="craft" data-idx="2"></div>
                            <div class="item-slot" style="width:35px; height:35px;" data-loc="craft" data-idx="3"></div>
                        </div>
                        <div class="craft-arrow">â”</div>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                            <div style="font-size:2em;">ğŸ“¦</div>
                            <button class="btn-game" style="font-size:0.9em; padding:5px 10px; min-width:auto;"
                                onclick="inventory.craft()">åˆæˆ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ ¼å­ -->
            <div>
                <div class="bag-col-title" style="text-align:left; margin-left:5px;">ç‰©å“æ  (å·¦é”®æ“ä½œ)</div>
                <div class="bag-grid" id="bag-grid-container"></div>
            </div>
        </div>
    </div>

    <!-- æ‰‹ç»˜é£æ ¼ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="hand-drawn-modal">
            <div class="modal-title">ğŸ¯ æœ¬å±€ç»“æœ</div>
            <div class="modal-message">è¦ç»§ç»­æŒ‘æˆ˜å—ï¼Ÿ</div>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="game.confirmNewRound(true)">ç»§ç»­æŒ‘æˆ˜</button>
                <button class="modal-btn cancel" onclick="game.confirmNewRound(false)">ç»“æŸæ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- è§‚æ˜Ÿå¼¹çª— -->
    <div class="modal-overlay" id="star-modal">
        <div class="hand-drawn-modal">
            <div class="modal-title">ğŸŒŸ è§‚æ˜Ÿç»“æœ</div>
            <div class="modal-message" id="star-message"></div>
            <div class="modal-buttons">
                <button class="modal-btn confirm"
                    onclick="document.getElementById('star-modal').style.display = 'none'">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const ITEMS_DB = {
            weapon: { id: 'weapon', icon: 'âš”ï¸', name: 'åˆºåˆ€', type: 'equip', prob: 0.5, desc: 'è£…å¤‡ï¼šè¾“æ‰çš„äººé¢å¤–-1åˆ†\n(åŒæ–¹ç”Ÿæ•ˆ)' },
            shield: { id: 'shield', icon: 'ğŸ›¡ï¸', name: 'æœ¨ç›¾', type: 'equip', prob: 0.5, desc: 'è£…å¤‡ï¼šå…å—æœ¬æ¬¡æ‰£åˆ†æƒ©ç½š\n(ä»…å¯¹è‡ªå·±)' },
            field: { id: 'field', icon: 'â›º', name: 'è¥åœ°', type: 'equip', prob: 0.5, desc: 'è£…å¤‡ï¼šæœ€å¤§ç‚¹æ•°ä¸Šé™å˜ä¸º24\n(åŒæ–¹ç”Ÿæ•ˆ)' },
            swap: { id: 'swap', icon: 'ğŸ”ƒ', name: 'äº¤æ¢', type: 'use', prob: 0.5, desc: 'æ¶ˆè€—ï¼šäº¤æ¢åŒæ–¹æœ€åä¸€å¼ ç‰Œ' },
            undo: { id: 'undo', icon: 'â†©ï¸', name: 'æ’¤å›', type: 'use', prob: 0.5, desc: 'æ¶ˆè€—ï¼šä¸¢å¼ƒä½ çš„æœ€åä¸€å¼ ç‰Œ' },
            axe: { id: 'axe', icon: 'ğŸª“', name: 'æ‰‹æ–§', type: 'use', prob: 0.5, desc: 'æ¶ˆè€—ï¼šç ´åå¯¹æ–¹ä¸€ä»¶è£…å¤‡' },
            star: { id: 'star', icon: 'ğŸŒŸ', name: 'è§‚æ˜Ÿ', type: 'use', prob: 0.4, desc: 'æ¶ˆè€—ï¼šå·çœ‹ç‰Œå †åº•éƒ¨çš„ç‰Œ' },
            book: { id: 'book', icon: 'ğŸ“–', name: 'ç¦ä¹¦', type: 'use', prob: 0.5, desc: 'æ¶ˆè€—ï¼šéšæœºæŠ½æŒ‡å®šç‚¹æ•°çš„ç‰Œ' }
        };

        const store = {
            deck: [], playerHand: [], aiHand: [],
            bag: Array(27).fill(null),
            equip: Array(4).fill(null),
            aiEquip: Array(4).fill(null),
            craft: Array(4).fill(null),
            playerHearts: 6,  // ç©å®¶èµ·å§‹çˆ±å¿ƒæ•°
            aiHearts: 6       // AIèµ·å§‹çˆ±å¿ƒæ•°
        };

        let passCounter = 0; // è®°å½•è¿ç»­Passæ¬¡æ•°

        const inventory = {
            init: function () {
                const grid = document.getElementById('bag-grid-container');
                grid.innerHTML = '';
                for (let i = 0; i < 27; i++) {
                    const div = document.createElement('div');
                    div.className = 'item-slot';
                    div.dataset.loc = 'bag'; div.dataset.idx = i;
                    grid.appendChild(div);
                }

                // ä¸»ç•Œé¢è£…å¤‡æ ï¼šç‚¹å‡»æ‰“å¼€èƒŒåŒ…
                document.querySelectorAll('#player-equip-strip .equip-slot').forEach(el => {
                    el.onclick = () => inventory.toggle();
                });

                // å…¨å±€ç‚¹å‡»å…³é—­èœå•ï¼ˆä½†æ’é™¤èœå•æœ¬èº«ï¼‰
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('ctx-menu');
                    if (menu && !menu.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
                this.render();
            },

            findEmptyBag: function () { return store.bag.findIndex(x => x === null); },
            findEmptyCraft: function () { return store.craft.findIndex(x => x === null); },

            addItem: function (item) {
                const idx = this.findEmptyBag();
                if (idx !== -1) {
                    store.bag[idx] = item;
                    this.render();
                    game.ui.msg(`è·å¾—: ${item.icon}${item.name}`);
                    const btn = document.querySelector('.btn-bag');
                    btn.style.transform = 'scale(1.2) rotate(10deg)';
                    setTimeout(() => btn.style.transform = 'none', 300);
                } else {
                    game.ui.msg("èƒŒåŒ…æ»¡å•¦!");
                }
            },

            // æ˜¾ç¤ºå³é”®èœå•
            showMenu: function (e, loc, idx) {
                e.preventDefault();
                const item = store[loc][idx];
                if (!item) return;

                const menu = document.getElementById('ctx-menu');
                menu.innerHTML = '';
                menu.style.display = 'flex';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';

                const addBtn = (txt, cb) => {
                    const b = document.createElement('div');
                    b.className = 'ctx-btn';
                    b.innerText = txt;
                    b.onclick = (evt) => {
                        evt.stopPropagation();
                        cb();
                        menu.style.display = 'none';
                    };
                    menu.appendChild(b);
                };

                if (loc === 'bag') {
                    addBtn(item.type === 'equip' ? "âœ¨ è£…å¤‡" : "ğŸª„ ä½¿ç”¨", () => this.useItem(loc, idx));
                    addBtn("â¡ï¸ æ”¾å…¥åˆæˆ", () => this.moveToCraft(idx));
                } else if (loc === 'craft') {
                    addBtn("â¬…ï¸ ç§»å›èƒŒåŒ…", () => this.moveFromCraft(idx));
                } else if (loc === 'equip') {
                    // è£…å¤‡å·²é”å®šï¼Œä¸æ˜¾ç¤ºå¸ä¸‹ï¼Œæˆ–è€…ä»…æç¤º
                    // addBtn("å·²é”å®š (æ— æ³•å¸ä¸‹)", () => {});
                }
            },

            moveToCraft: function (bagIdx) {
                const craftIdx = this.findEmptyCraft();
                if (craftIdx === -1) { game.ui.msg("åˆæˆå°æ»¡å•¦"); return; }
                const item = store.bag[bagIdx];
                store.bag[bagIdx] = null;
                store.craft[craftIdx] = item;
                this.render();
            },

            moveFromCraft: function (craftIdx) {
                const bagIdx = this.findEmptyBag();
                if (bagIdx === -1) { game.ui.msg("èƒŒåŒ…æ»¡å•¦"); return; }
                const item = store.craft[craftIdx];
                store.craft[craftIdx] = null;
                store.bag[bagIdx] = item;
                this.render();
            },

            useItem: function (loc, idx) {
                const list = store[loc];
                const item = list[idx];
                if (!item) return;

                if (item.type === 'equip') {
                    const emptySlot = store.equip.findIndex(x => x === null);
                    if (emptySlot !== -1) {
                        store.equip[emptySlot] = item;
                        list[idx] = null;
                        this.render();
                        game.updateBuffs();
                    } else {
                        game.ui.msg("è£…å¤‡æ å·²æ»¡");
                    }
                } else {
                    if (!game.isPlayerTurn) { game.ui.msg("éä½ çš„å›åˆ"); return; }
                    if (game.applyEffect(item)) {
                        list[idx] = null;
                        this.render();
                    }
                }
            },

            craft: function () {
                const items = store.craft.filter(x => x !== null);
                if (items.length < 3) { game.ui.msg("åˆæˆéœ€è¦3ä¸ªç‰©å“"); return; }
                let cnt = 0;
                for (let i = 0; i < 4; i++) {
                    if (store.craft[i] && cnt < 3) { store.craft[i] = null; cnt++; }
                }
                const newItem = game.lootSystem.generate(true);
                this.addItem(newItem);
                game.ui.msg("åˆæˆæˆåŠŸ! âœ¨");
                this.render();
            },

            toggle: function () {
                const el = document.getElementById('bag-modal');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            },

            render: function () {
                const renderOne = (loc, idx, item, canInteract) => {
                    let selector = `#bag-modal .item-slot[data-loc="${loc}"][data-idx="${idx}"]`;
                    if (loc === 'equip') selector = `#bag-modal .equip-slot[data-loc="${loc}"][data-idx="${idx}"]`;

                    const els = document.querySelectorAll(selector);
                    els.forEach(el => {
                        el.innerHTML = item ? `<div class="item-icon">${item.icon}</div>` : '';

                        // å·¦é”®èœå•ç»‘å®š
                        if (canInteract) {
                            el.onclick = (e) => {
                                if (item) {
                                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                                    inventory.showMenu(e, loc, idx);
                                }
                            };
                        }

                        // Tooltip
                        if (item) {
                            el.onmouseenter = (e) => {
                                const tt = document.getElementById('tooltip');
                                tt.innerText = `${item.name}\n${item.desc}`;
                                tt.style.display = 'block';
                                const rect = el.getBoundingClientRect();
                                tt.style.left = rect.right + 5 + 'px';
                                tt.style.top = rect.top + 'px';
                            };
                            el.onmouseleave = () => document.getElementById('tooltip').style.display = 'none';
                        } else { el.onmouseenter = null; }
                    });

                    // ä¸»ç•Œé¢ç©å®¶è£…å¤‡
                    if (loc === 'equip') {
                        const mainEl = document.querySelector(`#player-equip-strip .equip-slot[data-idx="${idx}"]`);
                        if (mainEl) {
                            mainEl.innerHTML = item ? item.icon : '';
                            mainEl.title = item ? item.name : 'ç‚¹å‡»æ‰“å¼€èƒŒåŒ…';
                            mainEl.style.cursor = 'pointer';
                        }
                    }
                };

                store.bag.forEach((it, i) => renderOne('bag', i, it, true));
                store.equip.forEach((it, i) => renderOne('equip', i, it, false)); // è£…å¤‡æ ä¸å¯å³é”®å¸ä¸‹
                store.craft.forEach((it, i) => renderOne('craft', i, it, true));

                const aiStrip = document.getElementById('ai-equip-strip');
                aiStrip.innerHTML = '';
                store.aiEquip.forEach(it => {
                    const div = document.createElement('div');
                    div.className = 'equip-slot';
                    div.innerText = it ? it.icon : '';
                    div.title = it ? it.name : '';
                    aiStrip.appendChild(div);
                });
                game.updateBuffs();  // æ·»åŠ è¿™è¡Œæ¥æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            }
        };

        const game = {
            isPlayerTurn: false,
            lootSystem: {
                generate: function () {
                    const keys = Object.keys(ITEMS_DB);
                    const key = keys[Math.floor(Math.random() * keys.length)];
                    const tpl = ITEMS_DB[key];
                    if (key === 'book') {
                        const n = Math.floor(Math.random() * 11) + 1;
                        return { ...tpl, id: 'book_' + Date.now(), name: `ç¦ä¹¦:${n}`, target: n, desc: `æ¶ˆè€—: å¿…æŠ½æ•°å­—${n}\n(è‹¥æ— åˆ™å¤±æ•ˆ)` };
                    }
                    return { ...tpl, id: key + '_' + Date.now() };
                },
                tryDrop: function (chance) {
                    if (Math.random() < chance) inventory.addItem(this.generate());
                }
            },

            start: function () {
                document.getElementById('start-overlay').style.display = 'none';
                const selectedHearts = parseInt(document.getElementById('hearts-count').innerText);
                store.playerHearts = selectedHearts;
                store.aiHearts = selectedHearts;
                inventory.init();
                this.newRound();
            },

            newRound: function () {
                store.deck = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                store.playerHand = [];
                store.aiHand = [];
                passCounter = 0; // é‡ç½®passè®¡æ•°
                // æ¸…ç©ºç©å®¶å’ŒAIçš„è£…å¤‡
                store.equip = [null, null, null, null];
                store.aiEquip = [null, null, null, null];
                if (Math.random() > 0.7) {
                    const it = this.lootSystem.generate();
                    if (it.type === 'equip') {
                        // ä¸ºAIè£…å¤‡ä½¿ç”¨åŸºç¡€IDï¼Œç¡®ä¿èƒ½æ­£ç¡®åŒ¹é…
                        const baseItem = ITEMS_DB[it.id.split('_')[0]];
                        if (baseItem) {
                            store.aiEquip[0] = { ...baseItem, id: baseItem.id + '_ai_' + Date.now() };
                        }
                    }
                }
                this.ui.updateDeck();
                this.ui.clearTable();
                this.ui.msg("æ–°çš„ä¸€è½®å¼€å§‹äº†!");
                inventory.render();
                this.drawCard('player');
                this.drawCard('ai');

                this.isPlayerTurn = true;
                this.ui.toggleBtn(true);
                this.updateBuffs();
                this.updateHearts();  // åˆå§‹åŒ–çˆ±å¿ƒæ˜¾ç¤º
            },

            drawCard: function (role, val = null) {
                if (store.deck.length === 0) return null;
                let idx;
                if (val) {
                    idx = store.deck.indexOf(val);
                    if (idx === -1) return null;
                } else { idx = Math.floor(Math.random() * store.deck.length); }
                const card = store.deck[idx];
                store.deck.splice(idx, 1);
                if (role === 'player') store.playerHand.push(card);
                else store.aiHand.push(card);
                this.ui.renderCard(role, card, role === 'ai' && store.aiHand.length === 1);
                this.ui.updateDeck();
                this.updatePoints();
                return card;
            },

            // --- æ ¸å¿ƒå›åˆé€»è¾‘ä¿®æ­£ ---
            playerAction: function (act) {
                if (!this.isPlayerTurn) return;

                if (act === 'hit') {
                    const c = this.drawCard('player');
                    if (!c) { this.ui.msg("ç‰Œåº“ç©ºå•¦!"); return; }
                    this.lootSystem.tryDrop(0.8);
                    passCounter = 0; // æœ‰äººè¦ç‰Œï¼Œpassé‡ç½®
                    this.ui.msg("ä½ æ‘¸äº†ç‰Œï¼Œè½®åˆ°AI");
                } else {
                    this.ui.msg("ä½ é€‰æ‹©äº†è¿‡");
                    this.lootSystem.tryDrop(0.3);
                    passCounter++;
                }

                // æ— è®ºHitè¿˜æ˜¯Passï¼Œéƒ½åˆ‡æ¢å›åˆ
                this.isPlayerTurn = false;
                this.ui.toggleBtn(false);

                if (passCounter >= 2) {
                    setTimeout(() => this.settle(), 500);
                } else {
                    setTimeout(() => this.aiTurn(), 1000);
                }
            },

            aiTurn: function () {
                const sum = this.calcSum(store.aiHand);
                const limit = this.getBustLimit();
                let act = 'pass';

                if (store.deck.length > 0) {
                    // AI ç­–ç•¥
                    if (sum < limit - 6) act = 'hit';
                    else if (sum < limit - 3 && Math.random() > 0.5) act = 'hit';
                }

                if (act === 'hit') {
                    this.drawCard('ai');
                    this.ui.aiSay("æˆ‘è¿˜è¦ä¸€å¼ !");
                    passCounter = 0; // AIè¦ç‰Œï¼Œpassé‡ç½®
                    this.ui.msg("AI è¦äº†ç‰Œï¼Œè½®åˆ°ä½ ");
                } else {
                    this.ui.aiSay("å°±è¿™æ ·å§");
                    passCounter++;
                    this.ui.msg("AI é€‰æ‹©äº†è¿‡");
                }

                // æ£€æŸ¥ç»“æŸï¼Œæˆ–äº¤è¿˜å›åˆ
                if (passCounter >= 2) {
                    setTimeout(() => this.settle(), 500);
                } else {
                    this.isPlayerTurn = true;
                    this.ui.toggleBtn(true);
                }
            },

            applyEffect: function (item) {
                const key = item.id.split('_')[0];
                if (key === 'swap') {
                    if (store.playerHand.length < 1 || store.aiHand.length < 1) { this.ui.msg("æ²¡ç‰Œå¯æ¢"); return false; }
                    const p = store.playerHand.pop(); const a = store.aiHand.pop();
                    store.playerHand.push(a); store.aiHand.push(p);
                    this.redrawAll(); this.ui.msg("äº¤æ¢äº†æ‰‹ç‰Œ!"); return true;
                }
                if (key === 'undo') {
                    if (store.playerHand.length < 2) { this.ui.msg("åº•ç‰Œä¸èƒ½æ‰”"); return false; }
                    store.playerHand.pop();
                    this.redrawAll(); this.ui.msg("æ’¤å›äº†æœ€åä¸€å¼ ç‰Œ"); return true;
                }
                if (key === 'axe') {
                    const idx = store.aiEquip.findIndex(x => x);
                    if (idx === -1) { this.ui.msg("AIæ²¡æœ‰è£…å¤‡"); return false; }
                    const n = store.aiEquip[idx].name;
                    store.aiEquip[idx] = null;
                    inventory.render(); this.updateBuffs(); this.ui.msg(`ç ´åäº†AIçš„ ${n}!`); return true;
                }
                if (key === 'star') {
                    if (store.deck.length === 0) { this.ui.msg("ç‰Œåº“ç©ºäº†"); return false; }
                    const starCard = store.deck[0];
                    document.getElementById('star-message').innerText = `è§‚æµ‹ç»“æœ: ç‰Œå †åº•éƒ¨æ˜¯ [ ${starCard} ]`;
                    document.getElementById('star-modal').style.display = 'flex';
                    return true;
                }
                if (key === 'book') {
                    const c = this.drawCard('player', item.target);
                    if (c) this.ui.msg(`ç¦ä¹¦ç”Ÿæ•ˆ: æŠ½åˆ°äº† ${c}`);
                    else this.ui.msg(`ç‰Œåº“é‡Œæ²¡æœ‰ ${item.target}`);
                    return true;
                }
                return false;
            },

            getBustLimit: function () {
                const hasF = store.equip.some(x => x && x.id.startsWith('field')) || store.aiEquip.some(x => x && x.id.startsWith('field'));
                return hasF ? 24 : 21;
            },

            updatePoints: function (showRealAi = false) {
                const limit = this.getBustLimit();
                const pSum = this.calcSum(store.playerHand);

                let aSum = 0;
                if (showRealAi) {
                    aSum = this.calcSum(store.aiHand);
                } else {
                    for (let i = 1; i < store.aiHand.length; i++) aSum += store.aiHand[i];
                }

                document.getElementById('player-point-display').innerText = `${pSum}/${limit}`;
                document.getElementById('ai-point-display').innerText = `${aSum}/${limit}`;
            },

            updateBuffs: function () {
                const pWep = store.equip.some(x => x && x.id.startsWith('weapon'));
                const pShd = store.equip.some(x => x && x.id.startsWith('shield'));
                const aWep = store.aiEquip.some(x => x && x.id.startsWith('weapon'));

                document.getElementById('player-buffs').innerText = (pWep ? "âš”ï¸" : "") + (pShd ? "ğŸ›¡ï¸" : "");
                document.getElementById('ai-buffs').innerText = (aWep ? "âš”ï¸" : "");

                const limit = this.getBustLimit();
                if (limit === 24) {
                    document.body.style.backgroundColor = "#ebd4d4";
                    this.ui.msg("åœºåœ°: çˆ†ç‰Œä¸Šé™ 24");
                } else {
                    document.body.style.backgroundColor = "#f3eacb";
                }
                this.updatePoints();
            },

            settle: function () {
                this.ui.toggleBtn(false);
                document.getElementById('ai-cards').innerHTML = '';
                store.aiHand.forEach(c => this.ui.renderCard('ai', c, false));
                this.updatePoints(true);

                const pSum = this.calcSum(store.playerHand);
                const aSum = this.calcSum(store.aiHand);
                const limit = this.getBustLimit();

                let pVal = pSum > limit ? -1 : pSum;
                let aVal = aSum > limit ? -1 : aSum;

                let pDmg = 0, aDmg = 0, msg = "å¹³å±€";

                if (pVal > aVal) { msg = "ä½ èµ¢äº†!"; aDmg = 1; }
                else if (aVal > pVal) { msg = "AIèµ¢äº†!"; pDmg = 1; }

                // ä¿®å¤è£…å¤‡é“å…·çš„ç”Ÿæ•ˆé€»è¾‘
                const pWeapon = store.equip.some(x => x && x.id.startsWith('weapon'));
                const pShield = store.equip.some(x => x && x.id.startsWith('shield'));
                const aWeapon = store.aiEquip.some(x => x && x.id.startsWith('weapon'));

                // åˆºåˆ€æ•ˆæœï¼šè¾“æ‰çš„äººé¢å¤–-1åˆ†
                if (pWeapon || aWeapon) {
                    if (pVal > aVal) aDmg++;
                    else if (aVal > pVal) pDmg++;
                }

                // æœ¨ç›¾æ•ˆæœï¼šå…å—æœ¬æ¬¡æ‰£åˆ†æƒ©ç½š
                if (pDmg > 0 && pShield) {
                    pDmg = 0; msg += " (ç›¾ç‰Œé˜²å¾¡!)";
                }

                // åº”ç”¨ä¼¤å®³åˆ°çˆ±å¿ƒç³»ç»Ÿ
                const oldPlayerHearts = store.playerHearts;
                const oldAiHearts = store.aiHearts;
                store.playerHearts = Math.max(0, store.playerHearts - pDmg);
                store.aiHearts = Math.max(0, store.aiHearts - aDmg);

                // æ˜¾ç¤ºä¼¤å®³åŠ¨ç”»
                this.showDamageAnimation(pDmg, aDmg, oldPlayerHearts, oldAiHearts);

                this.ui.msg(`${msg} (ä½ -${pDmg}, AI-${aDmg})`);

                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (store.playerHearts <= 0 || store.aiHearts <= 0) {
                    let finalMsg = "";
                    if (store.playerHearts <= 0 && store.aiHearts <= 0) {
                        finalMsg = "å¹³å±€ï¼åŒæ–¹çˆ±å¿ƒéƒ½è€—å°½äº†";
                    } else if (store.playerHearts <= 0) {
                        finalMsg = "æ¸¸æˆç»“æŸï¼AIè·èƒœï¼";
                    } else {
                        finalMsg = "æ¸¸æˆç»“æŸï¼ä½ è·èƒœäº†ï¼";
                    }

                    setTimeout(() => {
                        document.getElementById('confirm-modal').style.display = 'flex';
                        document.querySelector('.modal-message').innerText = finalMsg + "\\n\\nå¯¹æ–¹: " + aSum + " / ä¹™æ–¹: " + pSum;
                    }, 1500);
                } else {
                    setTimeout(() => {
                        document.getElementById('confirm-modal').style.display = 'flex';
                        document.querySelector('.modal-message').innerText = "å¯¹æ–¹: " + aSum + " / ä¹™æ–¹: " + pSum;
                    }, 1500);
                }
            },

            calcSum: function (arr) { return arr.reduce((a, b) => a + b, 0); },

            redrawAll: function () {
                this.ui.clearTable(true);
                store.playerHand.forEach(c => this.ui.renderCard('player', c));
                store.aiHand.forEach((c, i) => this.ui.renderCard('ai', c, i === 0));
                this.updatePoints();
            },

            updateHearts: function () {
                // æ¸²æŸ“ç©å®¶çˆ±å¿ƒ
                const playerContainer = document.getElementById('player-hearts-container');
                playerContainer.innerHTML = '';
                const maxHearts = Math.max(store.playerHearts, store.aiHearts);
                for (let i = 0; i < maxHearts; i++) {
                    const heart = document.createElement('span');
                    heart.className = 'heart' + (i >= store.playerHearts ? ' lost' : '');
                    heart.innerText = 'â¤ï¸';
                    playerContainer.appendChild(heart);
                }

                // æ¸²æŸ“AIçˆ±å¿ƒ
                const aiContainer = document.getElementById('ai-hearts-container');
                aiContainer.innerHTML = '';
                for (let i = 0; i < maxHearts; i++) {
                    const heart = document.createElement('span');
                    heart.className = 'heart' + (i >= store.aiHearts ? ' lost' : '');
                    heart.innerText = 'â¤ï¸';
                    aiContainer.appendChild(heart);
                }

                // æ·»åŠ è­¦å‘Šæ•ˆæœï¼ˆçˆ±å¿ƒæ•°é‡å°‘äº3æ—¶é—ªçƒï¼‰
                if (store.playerHearts <= 3 && store.playerHearts > 0) {
                    const playerHearts = document.querySelectorAll('#player-hearts-container .heart:not(.lost)');
                    playerHearts.forEach(heart => {
                        heart.classList.add('warning');
                    });
                }

                if (store.aiHearts <= 3 && store.aiHearts > 0) {
                    const aiHearts = document.querySelectorAll('#ai-hearts-container .heart:not(.lost)');
                    aiHearts.forEach(heart => {
                        heart.classList.add('warning');
                    });
                }
            },

            showDamageAnimation: function (pDmg, aDmg, oldPlayerHearts, oldAiHearts) {
                // å…ˆæ›´æ–°çˆ±å¿ƒæ˜¾ç¤º
                this.updateHearts();

                // ç©å®¶ä¼¤å®³åŠ¨ç”»
                if (pDmg > 0) {
                    const playerHearts = document.querySelectorAll('#player-hearts-container .heart');
                    for (let i = oldPlayerHearts - pDmg; i < oldPlayerHearts; i++) {
                        if (playerHearts[i]) {
                            playerHearts[i].classList.add('damage');
                            setTimeout(() => {
                                playerHearts[i].classList.remove('damage');
                            }, 600);
                        }
                    }
                }

                // AIä¼¤å®³åŠ¨ç”»
                if (aDmg > 0) {
                    const aiHearts = document.querySelectorAll('#ai-hearts-container .heart');
                    for (let i = oldAiHearts - aDmg; i < oldAiHearts; i++) {
                        if (aiHearts[i]) {
                            aiHearts[i].classList.add('damage');
                            setTimeout(() => {
                                aiHearts[i].classList.remove('damage');
                            }, 600);
                        }
                    }
                }
            },

            ui: {
                renderCard: function (role, val, hidden) {
                    const div = document.createElement('div');
                    div.className = 'card' + (hidden ? ' hidden' : '');
                    div.innerText = hidden ? '?' : val;
                    div.style.transform = `rotate(${Math.floor(Math.random() * 8) - 4}deg)`;
                    if (!hidden && val >= 10) div.style.color = "#c0392b";
                    document.getElementById(role + '-cards').appendChild(div);
                },
                clearTable: function (visOnly) {
                    document.getElementById('player-cards').innerHTML = '';
                    document.getElementById('ai-cards').innerHTML = '';
                    document.getElementById('ai-msg').innerText = '';
                },
                msg: function (t) { document.getElementById('game-msg').innerText = t; },
                aiSay: function (t) { document.getElementById('ai-msg').innerText = t; },
                updateDeck: function () { document.getElementById('deck-count').innerText = store.deck.length; },
                toggleBtn: function (on) {
                    document.getElementById('btn-hit').disabled = !on;
                    document.getElementById('btn-pass').disabled = !on;
                    if (on && store.deck.length === 0) document.getElementById('btn-hit').disabled = true;
                }
            }
        };

        game.confirmNewRound = function (confirm) {
            // å…³é—­å¼¹çª—
            document.getElementById('confirm-modal').style.display = 'none';

            if (confirm) {
                // å¦‚æœæ¸¸æˆç»“æŸï¼Œé‡ç½®çˆ±å¿ƒ
                if (store.playerHearts <= 0 || store.aiHearts <= 0) {
                    const selectedHearts = parseInt(document.getElementById('hearts-count').innerText);
                    store.playerHearts = selectedHearts;
                    store.aiHearts = selectedHearts;
                }
                this.newRound();
            }
        };

        function changeHeartsCount(change) {
            let currentCount = parseInt(document.getElementById('hearts-count').innerText);
            currentCount += change;
            if (currentCount < 1) currentCount = 1;
            if (currentCount > 10) currentCount = 10;
            document.getElementById('hearts-count').innerText = currentCount;
            document.getElementById('preview-hearts').innerHTML = '';
            for (let i = 0; i < currentCount; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.innerText = 'â¤ï¸';
                document.getElementById('preview-hearts').appendChild(heart);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çˆ±å¿ƒé¢„è§ˆ
        window.onload = function () {
            changeHeartsCount(0);
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
        };
    </script>
</body>

</html>