<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>金桔猪的博客·更多</title>
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="ideas.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="common.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: 'rgb(var(--primary))',
            secondary: 'rgb(var(--secondary))',
            accent: 'rgb(var(--accent))',
            surface: 'rgb(var(--surface))',
            'on-surface': 'rgb(var(--on-surface))',
            card: 'rgb(var(--card))',
            border: 'rgb(var(--border))'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-surface text-on-surface min-h-screen font-sans">
  <div id="splashScreen">
    <div class="loader"></div>
  </div>
  <div data-include="sidebar.html"></div>
  <div id="content" class="ml-[72px]">
    <header class="py-2 text-center">
      <button id="addCardBtn" class="px-4 py-2 bg-primary text-white rounded hidden">新增卡片</button>
      <button id="loadGistsBtn" class="px-4 py-2 bg-secondary text-white rounded hidden">加载 Gist</button>
    </header>
    <main class="px-4 max-w-screen-xl mx-auto pb-8">
      <div class="masonry" id="gallery"></div>
    </main>
    <div data-include="settings.html"></div>
    <div id="articleModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-card text-on-surface rounded-xl w-11/12 max-w-3xl h-[80vh] overflow-auto relative p-4">
        <button id="closeArticle" class="absolute top-2 right-4 text-2xl">&times;</button>
        <div id="articleContent" class="prose max-w-none whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    window.commonReady?.then(() => {
      const gallery = document.getElementById('gallery');
      const addCardBtn = document.getElementById('addCardBtn');
      const sidebarAddBtn = document.getElementById('addBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const moreBtn = document.getElementById('moreBtn');
      const closeSettings = document.getElementById('closeSettings');
      const applySettings = document.getElementById('applySettings');
      const loadGistsBtn = document.getElementById('loadGistsBtn');
      const githubTokenInput = document.getElementById('githubTokenInput');
      const columnCountInput = document.getElementById('columnCountInput');
      const perPageInput = document.getElementById('perPageInput');
      const multiTagToggle = document.getElementById('multiTagToggle');
      const articleModal = document.getElementById('articleModal');
      const closeArticle = document.getElementById('closeArticle');
      const articleContent = document.getElementById('articleContent');
      const clearCacheBtn = document.getElementById('clearCache');
      const navEl = document.querySelector('nav');
      const contentEl = document.getElementById('content');
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

      const savedToken = localStorage.getItem('githubToken') || '';
      if (githubTokenInput) githubTokenInput.value = savedToken;
      if (savedToken) loadGistsBtn.classList.remove('hidden');

      const savedCols = parseInt(localStorage.getItem('columnCount')) || 4;
      const savedPerPage = parseInt(localStorage.getItem('perPage')) || 30;
      const multiTagsSaved = localStorage.getItem('multiTags') === 'true';
      const initialCols = isMobile ? 2 : savedCols;
      columnCountInput.value = String(initialCols);
      perPageInput.value = String(savedPerPage);
      multiTagToggle.checked = multiTagsSaved;
      gallery.style.columnCount = String(initialCols);
      if (isMobile) {
        document.body.classList.add('mobile');
        navEl.classList.add('mobile');
        contentEl.classList.remove('ml-[72px]');
        contentEl.classList.add('mb-[72px]');
      }
      let cards = [];
      load();
      render();

      function save() {
        localStorage.setItem('customCards', JSON.stringify(cards));
      }
      function load() {
        try {
          const stored = localStorage.getItem('customCards');
          if (stored) cards = JSON.parse(stored) || [];
        } catch {}
        if (cards.length === 0) {
          cards.push({
            title: '关于本站',
            description: '你好！这里是金桔猪，博客记录了我的部分设计，以及可能会有一些“代码”相关的内容。\n \n可以试试再点一次 + 号',
            url: '',
            tags: ['博客介绍']
          });
          save();
        }
      }

      function parseFrontMatter(text) {
        if (!text.startsWith('---')) return null;
        const end = text.indexOf('---', 3);
        if (end === -1) return null;
        const yaml = text.slice(3, end).trim();
        const rest = text.slice(end + 3).trimStart();
        const result = { tags: [] };
        const lines = yaml.split(/\n+/);
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.startsWith('title:')) {
            result.title = line.slice(6).trim();
          } else if (line.startsWith('describe:')) {
            result.description = line.slice(9).trim();
          } else if (line.startsWith('tags:')) {
            result.tags = [];
            while (++i < lines.length && lines[i].trim().startsWith('-')) {
              result.tags.push(lines[i].trim().replace(/^-\s*/, ''));
            }
            i--; // compensate final increment
          }
        }
        result.content = rest;
        return result;
      }

      function showArticle(content) {
        articleContent.textContent = content;
        articleModal.classList.remove('hidden');
        articleModal.classList.add('flex', 'show');
      }

      function hideArticle() {
        articleModal.classList.add('hidden');
        articleModal.classList.remove('flex', 'show');
        articleContent.textContent = '';
      }

      function createCard(item, index) {
        const wrapper = document.createElement('div');
        wrapper.className = 'masonry-item rounded-2xl shadow overflow-hidden flex flex-col';
        const text = document.createElement('div');
        text.className = 'card-content p-5 flex flex-col gap-2';
        const h2 = document.createElement('h2');
        h2.className = 'text-xl font-semibold mb-1';
        h2.textContent = item.title;
        const p = document.createElement('p');
        p.className = 'text-sm leading-relaxed';
        p.textContent = item.description || '';
        const bottom = document.createElement('div');
        bottom.className = 'flex items-end mt-auto gap-2';
        const tagsEl = document.createElement('div');
        tagsEl.className = 'flex-1 flex overflow-x-auto whitespace-nowrap gap-1 no-scrollbar';
        if (Array.isArray(item.tags)) {
          item.tags.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'text-xs text-gray-400';
            span.textContent = '#' + tag;
            tagsEl.appendChild(span);
          });
        }
        bottom.appendChild(tagsEl);
        let link;
        if (item.url) {
          link = document.createElement('a');
          link.className = 'text-xs text-gray-400 flex-none self-end';
          link.textContent = '查看链接';
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.addEventListener('click', e => e.stopPropagation());
        }
        const delBtn = document.createElement('button');
        delBtn.className = 'text-xs text-[rgb(var(--card))] flex-none';
        delBtn.textContent = '·';
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if (confirm('确定删除？')) {
            cards.splice(index, 1);
            save();
            render();
          }
        });
        
        text.appendChild(h2);
        text.appendChild(p);
        text.appendChild(bottom);
        bottom.appendChild(delBtn);
        if (link) bottom.appendChild(link);
        wrapper.appendChild(text);
        wrapper.addEventListener('click', () => {
          if (item.content) {
            showArticle(item.content);
          } else if (item.url) {
            window.open(item.url, '_blank');
          }
        });
        return wrapper;
      }
      function render() {
        gallery.innerHTML = '';
        cards.forEach((item, idx) => {
          gallery.appendChild(createCard(item, idx));
        });
      }
      function handleCreate() {
        const title = prompt('标题');
        if (!title) return;
        const description = prompt('描述') || '';
        const url = prompt('链接（可选）') || '';
        const tags = (prompt('标签（用空格分隔，可选）') || '').split(/\s+/).filter(Boolean);
        cards.push({ title, description, url, tags });
        save();
        render();
      }

      async function fetchGists() {
        const token = localStorage.getItem('githubToken');
        if (!token) {
          alert('请在设置中填写 GitHub Token');
          return;
        }
        try {
          const res = await fetch('https://api.github.com/gists', {
            headers: { Authorization: 'token ' + token }
          });
          if (!res.ok) throw new Error('network');
          const data = await res.json();
          for (const g of data) {
            if (g.description !== 'flow-gist') continue;
            for (const [name, f] of Object.entries(g.files)) {
              const url = g.html_url + '?file=' + encodeURIComponent(name);
              if (cards.find(c => c.url === url)) continue;
              let text = '';
              try {
                const r = await fetch(f.raw_url);
                if (r.ok) text = await r.text();
              } catch {}
              const fm = parseFrontMatter(text);
              if (fm) {
                cards.push({
                  title: fm.title || name,
                  description: fm.description || '',
                  url,
                  tags: fm.tags.length ? fm.tags : ['gist'],
                  content: fm.content.trim()
                });
              } else {
                cards.push({
                  title: name,
                  description: '',
                  url,
                  tags: ['gist'],
                  content: text.trim()
                });
              }
            }
          }
          save();
          render();
        } catch (e) {
          alert('拉取失败');
          console.error(e);
        }
      }
      addCardBtn.addEventListener('click', handleCreate);
      loadGistsBtn.addEventListener('click', fetchGists);
      if (sidebarAddBtn) {
        sidebarAddBtn.addEventListener('click', (e) => {
          e.preventDefault();
          handleCreate();
        });
      }
      moreBtn.addEventListener('click', (e) => {
        e.preventDefault();
        settingsPanel.classList.remove('hidden');
        settingsPanel.classList.add('flex', 'show');
      });
      closeSettings.addEventListener('click', () => {
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });
      closeArticle.addEventListener('click', hideArticle);
      articleModal.addEventListener('click', e => {
        if (e.target === articleModal) hideArticle();
      });
      multiTagToggle.addEventListener('change', () => {
        localStorage.setItem('multiTags', multiTagToggle.checked ? 'true' : 'false');
      });
      applySettings.addEventListener('click', () => {
        const cols = Math.max(1, parseInt(columnCountInput.value) || 1);
        const perPage = Math.max(1, parseInt(perPageInput.value) || 1);
        gallery.style.columnCount = String(cols);
        localStorage.setItem('columnCount', String(cols));
        localStorage.setItem('perPage', String(perPage));
        if (githubTokenInput) {
          const t = githubTokenInput.value.trim();
          localStorage.setItem('githubToken', t);
          if (t) loadGistsBtn.classList.remove('hidden');
          else loadGistsBtn.classList.add('hidden');
        }
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });
      clearCacheBtn.addEventListener('click', async () => {
        ['customCards', 'wxData', 'wxDataNew', 'columnCount', 'perPage', 'githubToken'].forEach((k) => localStorage.removeItem(k));
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map((n) => caches.delete(n)));
        }
        location.reload();
      });
      
    hideSplash(true);
    });
  });
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
