<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>金桔猪的博客·更多</title>
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="ideas.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="common.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: 'rgb(var(--primary))',
            secondary: 'rgb(var(--secondary))',
            accent: 'rgb(var(--accent))',
            surface: 'rgb(var(--surface))',
            'on-surface': 'rgb(var(--on-surface))',
            card: 'rgb(var(--card))',
            border: 'rgb(var(--border))'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-surface text-on-surface min-h-screen font-sans">
  <div id="gistsProgress" class="fixed top-0 left-0 h-0.5 bg-[rgb(249,115,22)] w-0 opacity-0 transition-all z-50"></div>
  <div id="splashScreen">
    <div class="loader"></div>
  </div>
  <div data-include="sidebar.html"></div>
  <div id="content" class="ml-[72px]">
    <header class="py-2 text-center">
      <button id="addCardBtn" class="px-4 py-2 bg-primary text-white rounded hidden">新增卡片</button>
      <button id="newGistBtn" class="px-4 py-2 bg-primary text-white rounded ml-2 hidden">新增 Gist</button>
    </header>
    <div id="tagList" class="flex overflow-x-auto whitespace-nowrap gap-2 px-4 mb-4 no-scrollbar max-w-screen-xl mx-auto">
      <button id="loadGistsBtn" class="px-3 py-1 rounded-full text-sm border-2 border-transparent hover:border-primary bg-card hidden"> ↻ </button>
    </div>
    <main class="px-4 max-w-screen-xl mx-auto pb-8">
      <div class="masonry" id="gallery"></div>
    </main>
    <div data-include="settings.html"></div>
    <div id="articleModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-card text-on-surface rounded-xl w-11/12 max-w-3xl h-[80vh] overflow-auto relative p-4">
        <button id="closeArticle" class="absolute top-2 right-4 text-2xl">&times;</button>
        <div id="articleContent" class="prose max-w-none whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    window.commonReady?.then(() => {
      const gallery = document.getElementById('gallery');
      const addCardBtn = document.getElementById('addCardBtn');
      const newGistBtn = document.getElementById('newGistBtn');
      const sidebarAddBtn = document.getElementById('addBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const moreBtn = document.getElementById('moreBtn');
      const closeSettings = document.getElementById('closeSettings');
      const applySettings = document.getElementById('applySettings');
      const loadGistsBtn = document.getElementById('loadGistsBtn');
      const githubTokenInput = document.getElementById('githubTokenInput');
      const columnCountInput = document.getElementById('columnCountInput');
      const perPageInput = document.getElementById('perPageInput');
      const multiTagToggle = document.getElementById('multiTagToggle');
      const tagList = document.getElementById('tagList');
      const articleModal = document.getElementById('articleModal');
      const closeArticle = document.getElementById('closeArticle');
      const articleContent = document.getElementById('articleContent');
      const clearCacheBtn = document.getElementById('clearCache');
      const navEl = document.querySelector('nav');
      const contentEl = document.getElementById('content');
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

      const savedToken = localStorage.getItem('githubToken') || '';
      if (githubTokenInput) githubTokenInput.value = savedToken;
      if (savedToken) {
        loadGistsBtn.classList.remove('hidden');
        newGistBtn.classList.remove('hidden');
      }

      const savedCols = parseInt(localStorage.getItem('columnCount')) || 4;
      const savedPerPage = parseInt(localStorage.getItem('perPage')) || 30;
      const multiTagsSaved = localStorage.getItem('multiTags') === 'true';
      const initialCols = isMobile ? 2 : savedCols;
      columnCountInput.value = String(initialCols);
      perPageInput.value = String(savedPerPage);
      multiTagToggle.checked = multiTagsSaved;
      gallery.style.columnCount = String(initialCols);
      if (isMobile) {
        document.body.classList.add('mobile');
        navEl.classList.add('mobile');
        contentEl.classList.remove('ml-[72px]');
        contentEl.classList.add('mb-[72px]');
      }
      let cards = [];
      let selectedTags = [];
      let allowMultiTags = multiTagsSaved;
      load();
      updateTagsAndRender();

      function save() {
        localStorage.setItem('customCards', JSON.stringify(cards));
      }
      function load() {
        try {
          const stored = localStorage.getItem('customCards');
          if (stored) cards = JSON.parse(stored) || [];
        } catch {}
        if (cards.length === 0) {
          cards.push({
            title: '关于本站',
            description: '你好！这里是金桔猪，博客记录了我的部分设计，以及可能会有一些“代码”相关的内容。\n \n可以试试再点一次 + 号',
            url: '',
            tags: ['博客介绍']
          });
          save();
        }
      }

      function parseFrontMatter(text) {
        if (!text.startsWith('---')) return null;
        const end = text.indexOf('---', 3);
        if (end === -1) return null;
        const yaml = text.slice(3, end).trim();
        const rest = text.slice(end + 3).trimStart();
        const result = { tags: [] };
        const lines = yaml.split(/\n+/);
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.startsWith('title:')) {
            result.title = line.slice(6).trim();
          } else if (line.startsWith('describe:')) {
            result.description = line.slice(9).trim();
          } else if (line.startsWith('tags:')) {
            result.tags = [];
            while (++i < lines.length && lines[i].trim().startsWith('-')) {
              result.tags.push(lines[i].trim().replace(/^-\s*/, ''));
            }
            i--; // compensate final increment
          }
        }
        result.content = rest;
        return result;
      }

      function showArticle(content) {
        articleContent.textContent = content;
        articleModal.classList.remove('hidden');
        articleModal.classList.add('flex', 'show');
      }

      function hideArticle() {
        articleModal.classList.add('hidden');
        articleModal.classList.remove('flex', 'show');
        articleContent.textContent = '';
      }

      function createCard(item, index) {
        const wrapper = document.createElement('div');
        wrapper.className = 'masonry-item rounded-2xl shadow overflow-hidden flex flex-col';
        const text = document.createElement('div');
        text.className = 'card-content p-5 flex flex-col gap-2';
        const h2 = document.createElement('h2');
        h2.className = 'text-xl font-semibold mb-1';
        h2.textContent = item.title;
        const p = document.createElement('p');
        p.className = 'text-sm leading-relaxed';
        p.textContent = item.description || '';
        const bottom = document.createElement('div');
        bottom.className = 'flex items-end mt-auto gap-2';
        const tagsEl = document.createElement('div');
        tagsEl.className = 'flex-1 flex overflow-x-auto whitespace-nowrap gap-1 no-scrollbar';
        if (Array.isArray(item.tags)) {
          item.tags.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'text-xs text-gray-400';
            span.textContent = '#' + tag;
            tagsEl.appendChild(span);
          });
        }
        bottom.appendChild(tagsEl);
        let link;
        if (item.url) {
          link = document.createElement('a');
          link.className = 'text-xs text-gray-400 flex-none self-end';
          link.textContent = '查看链接';
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.addEventListener('click', e => e.stopPropagation());
        }
        const delBtn = document.createElement('button');
        delBtn.className = 'text-xs text-[rgb(var(--card))] flex-none';
        delBtn.textContent = '·';
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if (confirm('确定删除？')) {
            cards.splice(index, 1);
            save();
            updateTagsAndRender();
          }
        });

        if (item.gistId) {
          const editBtn = document.createElement('button');
          editBtn.className = 'text-xs text-primary flex-none';
          editBtn.textContent = '编辑';
          editBtn.addEventListener('click', e => {
            e.stopPropagation();
            handleEditGist(index);
          });
          bottom.appendChild(editBtn);
        }

        text.appendChild(h2);
        text.appendChild(p);
        text.appendChild(bottom);
        bottom.appendChild(delBtn);
        if (link) bottom.appendChild(link);
        wrapper.appendChild(text);
        wrapper.addEventListener('click', () => {
          if (item.content) {
            showArticle(item.content);
          } else if (item.url) {
            window.open(item.url, '_blank');
          }
        });
        return wrapper;
      }

      function collectTags() {
        const set = new Set();
        cards.forEach(c => {
          if (Array.isArray(c.tags)) c.tags.forEach(t => set.add(t));
        });
        return Array.from(set);
      }

      function renderTags(tags) {
        tagList.innerHTML = '';
        tagList.appendChild(loadGistsBtn);
        tags.forEach(t => {
          const btn = document.createElement('button');
          btn.dataset.tag = t;
          btn.textContent = t;
          btn.className = 'px-3 py-1 rounded-full text-sm border-2 border-transparent hover:border-primary bg-card';
          tagList.appendChild(btn);
        });
      }

      function applyFilter() {
        render();
        Array.from(tagList.querySelectorAll('button[data-tag]')).forEach(btn => {
          btn.classList.remove('bg-primary', 'text-white', 'border-primary');
          const tag = btn.dataset.tag;
          if (tag && selectedTags.includes(tag)) {
            btn.classList.add('bg-primary', 'text-white', 'border-primary');
          }
        });
      }

      function updateTagsAndRender() {
        renderTags(collectTags());
        applyFilter();
      }
      function render() {
        gallery.innerHTML = '';
        cards.forEach((item, idx) => {
          if (selectedTags.length && !selectedTags.every(t => Array.isArray(item.tags) && item.tags.includes(t))) {
            return;
          }
          gallery.appendChild(createCard(item, idx));
        });
      }
      function handleCreate() {
        const title = prompt('标题');
        if (!title) return;
        const description = prompt('描述') || '';
        const url = prompt('链接（可选）') || '';
        const tags = (prompt('标签（用空格分隔，可选）') || '').split(/\s+/).filter(Boolean);
        cards.push({ title, description, url, tags });
        save();
        updateTagsAndRender();
      }

      async function handleCreateGist() {
        const filename = prompt('文件名，例如 note.md');
        if (!filename) return;
        const content = prompt('内容') || '';
        const token = localStorage.getItem('githubToken');
        if (!token) {
          alert('请在设置中填写 GitHub Token');
          return;
        }
        try {
          const res = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers: {
              Authorization: 'token ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              description: 'flow-gist',
              public: false,
              files: { [filename]: { content } }
            })
          });
          if (!res.ok) throw new Error('create');
          const data = await res.json();
          const url = data.html_url + '?file=' + encodeURIComponent(filename);
          const fm = parseFrontMatter(content);
          if (fm) {
            cards.push({
              title: fm.title || filename,
              description: fm.description || '',
              url,
              tags: fm.tags.length ? fm.tags : ['gist'],
              content: fm.content.trim(),
              gistId: data.id,
              filename
            });
          } else {
            cards.push({
              title: filename,
              description: '',
              url,
              tags: ['gist'],
              content: content.trim(),
              gistId: data.id,
              filename
            });
          }
          save();
          updateTagsAndRender();
        } catch (e) {
          alert('创建失败');
          console.error(e);
        }
      }

      async function handleEditGist(index) {
        const item = cards[index];
        if (!item || !item.gistId) return;
        const token = localStorage.getItem('githubToken');
        if (!token) {
          alert('请在设置中填写 GitHub Token');
          return;
        }
        const content = prompt('修改内容', item.content || '');
        if (content === null) return;
        try {
          const res = await fetch('https://api.github.com/gists/' + item.gistId, {
            method: 'PATCH',
            headers: {
              Authorization: 'token ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ files: { [item.filename]: { content } } })
          });
          if (!res.ok) throw new Error('edit');
          item.content = content;
          const fm = parseFrontMatter(content);
          if (fm) {
            item.title = fm.title || item.filename;
            item.description = fm.description || '';
            item.tags = fm.tags.length ? fm.tags : ['gist'];
          }
          save();
          updateTagsAndRender();
        } catch (e) {
          alert('修改失败');
          console.error(e);
        }
      }

      async function fetchGists() {
        const token = localStorage.getItem('githubToken');
        if (!token) {
          alert('请在设置中填写 GitHub Token');
          return;
        }
        const progress = document.getElementById('gistsProgress');
        if (progress) {
          progress.style.width = '0%';
          progress.style.opacity = '1';
        }
        try {
          const res = await fetch('https://api.github.com/gists', {
            headers: { Authorization: 'token ' + token }
          });
          if (!res.ok) throw new Error('network');
          const data = await res.json();
          let done = 0;
          const total = data.length || 1;
          for (const g of data) {
            if (g.description !== 'flow-gist') continue;
            for (const [name, f] of Object.entries(g.files)) {
              const url = g.html_url + '?file=' + encodeURIComponent(name);
              if (cards.find(c => c.url === url)) continue;
              let text = '';
              try {
                const r = await fetch(f.raw_url);
                if (r.ok) text = await r.text();
              } catch {}
              const fm = parseFrontMatter(text);
              if (fm) {
                cards.push({
                  title: fm.title || name,
                  description: fm.description || '',
                  url,
                  tags: fm.tags.length ? fm.tags : ['gist'],
                  content: fm.content.trim(),
                  gistId: g.id,
                  filename: name
                });
              } else {
                cards.push({
                  title: name,
                  description: '',
                  url,
                  tags: ['gist'],
                  content: text.trim(),
                  gistId: g.id,
                  filename: name
                });
              }
            }
            done++;
            if (progress) progress.style.width = `${Math.min(100, (done / total) * 100)}%`;
          }
            save();
            updateTagsAndRender();
        } catch (e) {
          alert('拉取失败');
          console.error(e);
        } finally {
          if (progress) {
            progress.style.width = '100%';
            setTimeout(() => { progress.style.opacity = '0'; }, 300);
          }
        }
      }
      addCardBtn.addEventListener('click', handleCreate);
      newGistBtn.addEventListener('click', handleCreateGist);
      loadGistsBtn.addEventListener('click', fetchGists);
      if (sidebarAddBtn) {
        sidebarAddBtn.addEventListener('click', (e) => {
          e.preventDefault();
          handleCreate();
        });
      }
      tagList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-tag]');
        if (!btn) return;
        const tag = btn.dataset.tag;
        if (!tag) return;
        if (allowMultiTags) {
          if (selectedTags.includes(tag)) {
            selectedTags = selectedTags.filter(t => t !== tag);
          } else {
            selectedTags.push(tag);
          }
        } else {
          if (selectedTags.length === 1 && selectedTags[0] === tag) {
            selectedTags = [];
          } else {
            selectedTags = [tag];
          }
        }
        applyFilter();
      });
      moreBtn.addEventListener('click', (e) => {
        e.preventDefault();
        settingsPanel.classList.remove('hidden');
        settingsPanel.classList.add('flex', 'show');
      });
      closeSettings.addEventListener('click', () => {
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });
      closeArticle.addEventListener('click', hideArticle);
      articleModal.addEventListener('click', e => {
        if (e.target === articleModal) hideArticle();
      });
      multiTagToggle.addEventListener('change', () => {
        allowMultiTags = multiTagToggle.checked;
        localStorage.setItem('multiTags', allowMultiTags ? 'true' : 'false');
        if (!allowMultiTags && selectedTags.length > 1) {
          selectedTags = [selectedTags[0]];
        }
        applyFilter();
      });
      applySettings.addEventListener('click', () => {
        const cols = Math.max(1, parseInt(columnCountInput.value) || 1);
        const perPage = Math.max(1, parseInt(perPageInput.value) || 1);
        gallery.style.columnCount = String(cols);
        localStorage.setItem('columnCount', String(cols));
        localStorage.setItem('perPage', String(perPage));
        if (githubTokenInput) {
          const t = githubTokenInput.value.trim();
          localStorage.setItem('githubToken', t);
          if (t) {
            loadGistsBtn.classList.remove('hidden');
            newGistBtn.classList.remove('hidden');
          } else {
            loadGistsBtn.classList.add('hidden');
            newGistBtn.classList.add('hidden');
          }
        }
        settingsPanel.classList.add('hidden');
        settingsPanel.classList.remove('flex', 'show');
      });
      clearCacheBtn.addEventListener('click', async () => {
        ['customCards', 'wxData', 'wxDataNew', 'columnCount', 'perPage', 'githubToken'].forEach((k) => localStorage.removeItem(k));
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map((n) => caches.delete(n)));
        }
        location.reload();
      });
      
    hideSplash(true);
    });
  });
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
